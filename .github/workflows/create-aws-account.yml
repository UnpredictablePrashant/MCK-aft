name: ğŸš€ Create New AWS Account

# Simple workflow to request new AWS accounts
# Runs manually from GitHub Actions tab
on:
  workflow_dispatch:
    inputs:
      account_name:
        description: 'ğŸ“ Account Name (e.g., DevAccount)'
        required: true
        type: string
      
      account_email:
        description: 'ğŸ“§ Unique Account Email'
        required: true
        type: string
      
      organizational_unit:
        description: 'ğŸ¢ Organizational Unit'
        required: true
        type: choice
        options:
          - LearnMck
          - AFTLearn
      
      environment:
        description: 'ğŸŒ Environment Type'
        required: true
        type: choice
        options:
          - Development
          - Testing
          - Staging
          - Production

jobs:
  request-account:
    name: Create Account Request
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout main repo with submodules
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # Step 2: Configure Git
      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.name "AFT Automation"
          git config --global user.email "aft-automation@github.com"
      
      # Step 3: Update submodule
      - name: ğŸ“¦ Update Account Request Submodule
        run: |
          cd learn-terraform-aft-account-request
          git checkout main
          git pull origin main
      
      # Step 4: Create Account Request
      - name: ğŸ“ Create Account Request Module
        run: |
          cd learn-terraform-aft-account-request
          
          # Generate safe module name
          MODULE_NAME=$(echo "${{ inputs.account_name }}" | tr '[:upper:]' '[:lower:]' | tr ' ' '_' | tr -cd '[:alnum:]_')
          TIMESTAMP=$(date +%s)
          
          echo "Creating account request: ${MODULE_NAME}_${TIMESTAMP}"
          
          # Append to main.tf
          cat >> terraform/main.tf << EOF
          
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Account: ${{ inputs.account_name }}
          # Created: $(date '+%Y-%m-%d %H:%M:%S UTC')
          # Requested by: ${{ github.actor }}
          # Workflow Run: ${{ github.run_id }}
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          module "${MODULE_NAME}_${TIMESTAMP}" {
            source = "./modules/aft-account-request"
          
            control_tower_parameters = {
              AccountEmail              = "${{ inputs.account_email }}"
              AccountName               = "${{ inputs.account_name }}"
              ManagedOrganizationalUnit = "${{ inputs.organizational_unit }}"
              SSOUserEmail              = "ravish.snkhyn@gmail.com"
              SSOUserFirstName          = "Ravish"
              SSOUserLastName           = "Sankhyan"
            }
          
            account_tags = {
              "Environment"  = "${{ inputs.environment }}"
              "ManagedBy"    = "AFT"
              "RequestedBy"  = "${{ github.actor }}"
              "CreatedDate"  = "$(date +%Y-%m-%d)"
              "CreatedVia"   = "GitHub-Actions"
              "WorkflowRun"  = "${{ github.run_id }}"
            }
          
            change_management_parameters = {
              change_requested_by = "${{ github.actor }}"
              change_reason       = "Account request via GitHub Actions - Run #${{ github.run_id }}"
            }
          
            custom_fields = {
              workflow_run_id = "${{ github.run_id }}"
              github_actor    = "${{ github.actor }}"
              created_via     = "github_actions"
            }
          
            account_customizations_name = "sandbox"
          }
          EOF
          
          echo "âœ… Account request created!"
      
      # Step 5: Commit to Submodule
      - name: ğŸ’¾ Commit to Account Request Repo
        run: |
          cd learn-terraform-aft-account-request
          
          git add terraform/main.tf
          git commit -m "ğŸš€ New Account: ${{ inputs.account_name }}

          ğŸ“‹ Details:
          â€¢ Name: ${{ inputs.account_name }}
          â€¢ Email: ${{ inputs.account_email }}
          â€¢ OU: ${{ inputs.organizational_unit }}
          â€¢ Environment: ${{ inputs.environment }}
          â€¢ Requested by: ${{ github.actor }}
          â€¢ Workflow: ${{ github.run_id }}
          
          âš™ï¸ This will be automatically processed by AFT"
          
          git push origin main
          
          echo "âœ… Pushed to account-request repository!"
      
      # Step 6: Update Main Repo Submodule Reference
      - name: ğŸ”„ Update Main Repo Submodule
        run: |
          cd learn-terraform-aft-account-request
          COMMIT_SHA=$(git rev-parse HEAD)
          cd ..
          
          git add learn-terraform-aft-account-request
          git commit -m "Update submodule: New account request for ${{ inputs.account_name }}" || echo "No changes to main repo"
          git push origin main || echo "Nothing to push"
      
      # Step 7: Success Summary
      - name: ğŸ‰ Success!
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Account Request Submitted Successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ Account Details:"
          echo "   Name:        ${{ inputs.account_name }}"
          echo "   Email:       ${{ inputs.account_email }}"
          echo "   OU:          ${{ inputs.organizational_unit }}"
          echo "   Environment: ${{ inputs.environment }}"
          echo "   Requested:   $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "â° Timeline:"
          echo "   â€¢ 2 minutes  â†’ Pipeline auto-triggers"
          echo "   â€¢ 5 minutes  â†’ DynamoDB entry created"
          echo "   â€¢ 10 minutes â†’ AFT processing starts"
          echo "   â€¢ 20 minutes â†’ Account appears in Organizations"
          echo ""
          echo "ğŸ“Š Monitor at:"
          echo "   CodePipeline: https://ap-south-1.console.aws.amazon.com/codesuite/codepipeline/pipelines/ct-aft-account-request/view"
          echo "   Organizations: https://console.aws.amazon.com/organizations/v2/home/accounts"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # Step 8: GitHub Summary
      - name: ğŸ“Š Create Workflow Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸ‰ AWS Account Request Submitted!
          
          ### ğŸ“‹ Account Information
          
          | Field | Value |
          |-------|-------|
          | **Account Name** | ${{ inputs.account_name }} |
          | **Email** | `${{ inputs.account_email }}` |
          | **Organizational Unit** | ${{ inputs.organizational_unit }} |
          | **Environment** | ${{ inputs.environment }} |
          | **Requested By** | @${{ github.actor }} |
          | **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          
          ---
          
          ### â° What Happens Next?
          
          ```mermaid
          graph LR
              A[GitHub Push] -->|2 min| B[EventBridge]
              B --> C[CodePipeline]
              C -->|3 min| D[Terraform Apply]
              D --> E[DynamoDB]
              E -->|2 min| F[Lambda Processor]
              F --> G[SQS Queue]
              G -->|5 min| H[Account Processor]
              H --> I[Service Catalog]
              I -->|10 min| J[AWS Organizations]
              J --> K[âœ… Account Ready!]
          ```
          
          **Total Time:** ~20 minutes
          
          ---
          
          ### ğŸ“Š Monitor Progress
          
          - ğŸ” [**CodePipeline**](https://ap-south-1.console.aws.amazon.com/codesuite/codepipeline/pipelines/ct-aft-account-request/view) - Watch Terraform apply
          - ğŸ“¦ [**Step Functions**](https://ap-south-1.console.aws.amazon.com/states/home?region=ap-south-1) - Track provisioning
          - ğŸ¢ [**AWS Organizations**](https://console.aws.amazon.com/organizations/v2/home/accounts) - See created account
          
          ---
          
          ### ğŸ“§ Account Details
          
          Once provisioned, the account will be accessible at:
          - **Email:** `${{ inputs.account_email }}`
          - **SSO Portal:** https://d-906702c4e1.awsapps.com/start (use your SSO credentials)
          
          ---
          
          <details>
          <summary>ğŸ”§ Technical Details</summary>
          
          - **AFT Management Account:** 809574937450
          - **CT Management Account:** 535355705679
          - **Region:** ap-south-1
          - **Auto-Trigger:** EventBridge (every 2 minutes)
          - **State Backend:** S3 + DynamoDB
          
          </details>
          
          ---
          
          ğŸ¤– **Automated by AFT** | ğŸ”’ **Secured by AWS Control Tower**
          EOF

